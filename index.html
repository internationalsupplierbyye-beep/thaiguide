<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Thailand Guide â€“ Appointment Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --primary: #4f46e5;
      --primary-soft: #eef2ff;
      --accent: #f97316;
      --bg: #0f172a;
      --card-bg: #fff;
      --muted: #667085;
      --line: #e5e7eb;
      --ink: #111827;
      --success: #16a34a;
      --error: #dc2626;
    }
    * { box-sizing: border-box; }
    body{
      font-family:system-ui,Arial;margin:0;
      background: radial-gradient(circle at top left, #4f46e5 0, #0f172a 45%, #020617 100%);
      color:var(--ink);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:20px 10px;
    }
    .app-shell{
      position:relative;
      width:100%;
      max-width:1200px;
      background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(248,250,252,0.98));
      border-radius:18px;
      box-shadow:0 20px 40px rgba(15,23,42,.35), 0 0 0 1px rgba(148,163,184,.3);
      overflow:hidden;
    }
    header{
      padding:16px 24px 12px;
      border-bottom:1px solid rgba(148,163,184,.3);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      background: radial-gradient(circle at top right, #eef2ff, #ffffff);
      flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand-mark{
      width:34px;height:34px;border-radius:999px;
      background: conic-gradient(from 210deg, #4f46e5, #38bdf8, #f97316, #4f46e5);
      padding:2px;
    }
    .brand-mark-inner{
      width:100%;height:100%;
      border-radius:inherit;
      background:#020617;
      display:flex;align-items:center;justify-content:center;
      color:#e5e7eb;font-weight:800;font-size:14px;
    }
    .brand-text-title{font-weight:800;font-size:18px}
    .brand-text-sub{font-size:12px;color:var(--muted)}
    .header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .tabs{display:flex;gap:6px;background:rgba(15,23,42,.05);padding:3px;border-radius:999px}
    .tab-btn{
      border:none;background:transparent;
      padding:6px 14px;border-radius:999px;
      font-size:12px;cursor:pointer;
      display:flex;align-items:center;gap:6px;
      color:var(--muted);
      transition:all .18s ease;
      white-space:nowrap;
    }
    .tab-btn span.icon{font-size:14px}
    .tab-btn.active{
      background:#0f172a;color:#e5e7eb;
      box-shadow:0 0 0 1px rgba(148,163,184,.5);
    }
    .auth-box{
      display:flex;align-items:center;gap:6px;flex-wrap:wrap;
      background:#020617;color:#e5e7eb;
      padding:6px 10px;border-radius:999px;font-size:11px;
    }
    .auth-box input{
      border-radius:999px;border:1px solid #4b5563;
      background:#111827;color:#e5e7eb;
      padding:4px 10px;font-size:11px;outline:none;min-width:140px;
    }
    .auth-box input::placeholder{color:#6b7280}
    .btn-mini{
      border:none;border-radius:999px;
      padding:4px 10px;font-size:11px;
      cursor:pointer;background:#e5e7eb;color:#0f172a;
    }
    .auth-status{font-size:10px;color:#cbd5f5}
    main{padding:16px 20px 20px}
    .tab-panel{display:none;animation:fadeIn .18s ease-out}
    .tab-panel.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    .panel-card{
      background:var(--card-bg);
      border-radius:14px;
      padding:16px 18px 18px;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      border:1px solid var(--line);
    }
    .panel-header{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .panel-title{font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px}
    .badge{
      font-size:11px;padding:2px 8px;border-radius:999px;
      background:var(--primary-soft);color:var(--primary);
      border:1px solid rgba(129,140,248,.6);
    }
    .panel-desc{font-size:12px;color:var(--muted);max-width:760px}
    form{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:16px 18px;
      margin-top:8px;
    }
    .field{display:flex;flex-direction:column}
    .field label{font-size:12px;margin-bottom:4px;font-weight:700}
    .field small{font-size:11px;color:var(--muted)}
    input,select,textarea{
      padding:8px 10px;font-size:14px;border-radius:9px;
      border:1px solid #d4d4d8;outline:none;
      transition:all .16s ease;background:#f9fafb;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(79,70,229,.3);
      background:#fff;
    }
    textarea{min-height:70px;resize:vertical}
    .full-width{grid-column:1/-1}
    .actions{grid-column:1/-1;display:flex;flex-wrap:wrap;justify-content:flex-end;gap:8px;margin-top:4px}
    .btn{
      border:none;border-radius:999px;
      padding:8px 18px;font-size:13px;
      cursor:pointer;display:inline-flex;align-items:center;gap:6px;
      white-space:nowrap;
      transition:transform .1s ease, box-shadow .1s ease, background .15s ease;
    }
    .btn:active{transform:translateY(1px);box-shadow:none}
    .btn-primary{background:linear-gradient(135deg,#4f46e5,#6366f1);color:#fff;box-shadow:0 12px 22px rgba(79,70,229,.35)}
    .btn-secondary{background:#e5e7eb;color:#111827;box-shadow:0 6px 14px rgba(15,23,42,.18)}
    .btn-outline{background:transparent;border:1px dashed rgba(148,163,184,.9);color:#4b5563}
    .btn[disabled], .btn-mini[disabled]{opacity:.5;cursor:not-allowed;box-shadow:none}
    .message{margin-top:8px;font-size:12px;grid-column:1/-1}
    .message.success{color:var(--success)}
    .message.error{color:var(--error)}

    .toolbar{
      display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;
      align-items:center;font-size:12px;
    }
    .toolbar-group{display:flex;align-items:center;gap:6px}
    .toolbar input,.toolbar select{
      padding:4px 10px;font-size:12px;border-radius:999px;
      border:1px solid #d4d4d8;background:#f9fafb;
    }
    table{width:100%;border-collapse:collapse;font-size:12px;margin-top:4px;border-radius:10px;overflow:hidden}
    thead{background:#0f172a;color:#e5e7eb}
    th,td{padding:7px 8px;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    tbody tr:nth-child(even){background:#f9fafb}
    tbody tr:hover{background:#eef2ff}
    .tag{padding:2px 8px;border-radius:999px;font-size:11px;background:#eef2ff;color:#4f46e5}
    .status-pill{
      padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(148,163,184,.7);
      display:inline-block;
    }
    .status-pending{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .status-confirm{background:#ecfdf5;color:#166534;border-color:#bbf7d0}

    /* ===== Invoice ===== */
    .invoice-wrap{display:flex;gap:16px;flex-wrap:wrap}
    .invoice-controls{flex:1 1 240px}
    .invoice-card{
      flex:2 1 320px;
      background:#fff;border-radius:14px;border:1px solid #e5e7eb;
      padding:12px;
      box-shadow:0 10px 30px rgba(15,23,42,.25);
      width:500px;height:600px;margin:0 auto;
      display:flex;align-items:stretch;justify-content:center;
      position:relative;overflow:hidden;
    }
    .invoice-inner{width:100%;height:100%;display:flex;flex-direction:column}
    .invoice-header-main{
      display:flex;align-items:center;gap:10px;
      margin-bottom:8px;border-bottom:1px solid #e5e7eb;padding-bottom:8px;
    }
    .invoice-logo{width:64px;height:64px;border-radius:50%;overflow:hidden;flex-shrink:0}
    .invoice-logo img{width:100%;height:100%;object-fit:cover;display:block}
    .invoice-brand{font-weight:900;font-size:20px;letter-spacing:.04em;text-transform:uppercase}
    .invoice-sub{font-size:14px;color:#4b5563;font-weight:800}
    .invoice-meta-row{display:flex;justify-content:space-between;font-size:12.5px;color:#6b7280;margin-bottom:8px}
    .invoice-section-title{font-size:14px;font-weight:900;margin-top:10px;margin-bottom:6px}
    .invoice-grid{
      display:grid;grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px 12px;font-size:13px;
    }
    .invoice-label{color:#6b7280;font-weight:800}
    .invoice-value{font-weight:800;color:#111827; font-size:15px;} /* slightly bigger */
    .invoice-total{
      margin-top:auto;padding-top:10px;border-top:1px dashed #d4d4d8;
      display:flex;justify-content:space-between;align-items:flex-start;font-size:14px;
    }
    .invoice-total-amount{font-size:20px;font-weight:900}
    .chip{border-radius:999px;border:1px solid rgba(148,163,184,.7);padding:2px 7px;font-size:10px}

    /* ===== Settings ===== */
    .settings-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:14px 18px;margin-top:10px;
    }
    .settings-block{
      border-radius:12px;border:1px dashed rgba(148,163,184,.7);
      padding:10px 12px;background:#f9fafb;
    }
    .settings-block h4{margin:0 0 4px;font-size:13px}
    .pricing-row{
      display:grid;
      grid-template-columns:minmax(0,1fr) 90px 90px;
      gap:4px 8px;align-items:center;font-size:12px;margin-bottom:4px;
    }
    .pricing-row span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .pricing-row input{font-size:12px;padding:4px 6px;border-radius:7px}

    .auth-overlay{
      position:absolute;inset:0;
      background:rgba(15,23,42,.82);
      color:#e5e7eb;
      display:flex;align-items:center;justify-content:center;
      text-align:center;padding:20px;z-index:40;font-size:14px;
      pointer-events:none;
    }
    .auth-overlay.hidden{display:none}

    @media (max-width: 640px){
      .invoice-grid{grid-template-columns:1fr}
      .invoice-card{width:100%;height:90vh}
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <div id="authOverlay" class="auth-overlay">
      ğŸ”’ System Locked â€“ Please login with your Thailand Guide account<br/><br/>
      <span style="font-size:12px;opacity:.85;">
        (Admin / Staff Email &amp; Password á€á€Šá€º Firebase Console á€™á€¾á€¬ á€á€á€ºá€™á€¾á€á€ºá€‘á€¬á€¸á€á€Šá€·á€º Account á€–á€¼á€…á€ºá€›á€•á€«á€™á€Šá€º)
      </span>
    </div>

    <header>
      <div class="brand">
        <div class="brand-mark"><div class="brand-mark-inner">TG</div></div>
        <div>
          <div class="brand-text-title">Thailand Guide Â· Appointment Hub</div>
          <div class="brand-text-sub">Data Entry â€¢ Invoice â€¢ Dashboard â€¢ Telegram Alert</div>
        </div>
      </div>

      <div class="header-right">
        <div class="tabs">
          <button class="tab-btn active" data-tab="entry"><span class="icon">ğŸ“</span> Entry</button>
          <button class="tab-btn" data-tab="dashboard"><span class="icon">ğŸ“Š</span> Dashboard</button>
          <button class="tab-btn" data-tab="invoice"><span class="icon">ğŸ§¾</span> Invoice</button>
          <button class="tab-btn admin-only" data-tab="settings" id="settingsTabBtn"><span class="icon">âš™ï¸</span> Settings</button>
        </div>

        <div class="auth-box">
          <input id="loginEmail" type="email" placeholder="email@example.com">
          <input id="loginPassword" type="password" placeholder="password">
          <button class="btn-mini" id="loginBtn">Login</button>
          <button class="btn-mini" id="logoutBtn" style="display:none;">Logout</button>
          <div class="auth-status" id="authStatus">Not signed in</div>
        </div>
      </div>
    </header>

    <main>
      <!-- ENTRY -->
      <section id="tab-entry" class="tab-panel active">
        <div class="panel-card">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span>ğŸ“ Customer Appointment Data</span> <span class="badge">Live Firestore Save</span></div>
              <div class="panel-desc">Invoice á€‘á€¯á€á€ºá€™á€Šá€·á€º á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€’á€®á€”á€±á€›á€¬á€™á€¾á€¬ á€…á€”á€…á€ºá€á€€á€» á€œá€€á€ºá€á€¶á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€«á€á€šá€ºá‹</div>
            </div>
            <span class="chip">Staff can save â€¢ Admin can edit/export</span>
          </div>

          <form id="appointmentForm">
            <div class="field">
              <label for="invoiceId">Invoice ID</label>
              <input type="text" id="invoiceId" placeholder="TG-2025-0001" required />
              <small>á€‘á€•á€ºá€™á€•á€±á€«á€ºá€™á€šá€·á€º ID á€•á€±á€¸á€•á€« (á€¥á€•á€™á€¬ TG-2025-0001)</small>
            </div>

            <div class="field">
              <label for="date">á€…á€¬á€›á€„á€ºá€¸á€á€½á€„á€ºá€¸á€›á€€á€º</label>
              <input type="date" id="date" required />
            </div>

            <div class="field">
              <label for="appointmentDate">á€á€”á€ºá€†á€±á€¬á€„á€ºá€™á€¾á€¯á€›á€šá€°á€™á€Šá€·á€ºá€›á€€á€º</label>
              <input type="date" id="appointmentDate" required />
            </div>

            <!-- âœ… NEW: Time (optional) -->
            <div class="field">
              <label for="appointmentTime">á€á€”á€ºá€†á€±á€¬á€„á€ºá€™á€¾á€¯á€šá€°á€›á€”á€ºá€œá€¬á€›á€™á€Šá€·á€ºá€¡á€á€»á€­á€”á€º</label>
              <input type="time" id="appointmentTime" step="300" />
              <small>á€™á€›á€½á€±á€¸á€œá€Šá€ºá€¸ Save á€›á€•á€«á€á€šá€º (Optional)</small>
            </div>

            <div class="field">
              <label for="name">á€¡á€™á€Šá€º</label>
              <input type="text" id="name" placeholder="Customer Name" required />
            </div>

            <div class="field">
              <label for="phone">á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º</label>
              <input type="tel" id="phone" placeholder="0XXXXXXXXX" required />
            </div>

            <div class="field">
              <label for="customerStatus">Customer Status</label>
              <select id="customerStatus" required>
                <option value="">-- Select --</option>
                <option value="Pending">Pending</option>
                <option value="Confirm">Confirm</option>
              </select>
              <small>Dashboard á€™á€¾á€¬á€á€¬ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€™á€šá€º</small>
            </div>

            <div class="field">
              <label for="channel">Customer Channel</label>
              <select id="channel"></select>
            </div>

            <div class="field">
              <label for="location">á€á€”á€ºá€†á€±á€¬á€„á€ºá€™á€¾á€¯á€šá€°á€™á€Šá€·á€ºá€”á€±á€›á€¬</label>
              <select id="location" required></select>
            </div>

            <div class="field">
              <label for="serviceType">á€á€”á€ºá€†á€±á€¬á€„á€ºá€™á€¾á€¯á€¡á€™á€»á€­á€¯á€¸á€¡á€…á€¬á€¸</label>
              <select id="serviceType" required></select>
            </div>

            <div class="field">
              <label for="paymentType">á€„á€½á€±á€•á€±á€¸á€á€»á€±á€™á€¾á€¯á€¡á€™á€»á€­á€¯á€¸á€¡á€…á€¬á€¸</label>
              <select id="paymentType" required></select>
              <small>Deposit á€›á€¾á€­á€›á€„á€º Deposit Amount á€‘á€Šá€·á€ºá€•á€«</small>
            </div>

            <div class="field">
              <label for="price">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸ (THB)</label>
              <input type="number" id="price" min="0" step="0.01" placeholder="0.00" required />
            </div>

            <div class="field">
              <label for="depositAmount">Deposit Amount (THB)</label>
              <input type="number" id="depositAmount" min="0" step="0.01" placeholder="0.00" />
              <small>Payment Type á€˜á€¬á€›á€½á€±á€¸á€›á€½á€±á€¸ á€‘á€Šá€·á€ºá€œá€­á€¯á€·á€›</small>
            </div>

            <div class="field">
              <label for="balanceAmount">Balance (Auto) (THB)</label>
              <input type="number" id="balanceAmount" placeholder="0.00" disabled />
              <small>Auto = Total - Deposit (Deposit á€™á€‘á€Šá€·á€ºá€›á€„á€º Total)</small>
            </div>

            <div class="field full-width">
              <label for="remark">á€™á€¾á€á€ºá€á€»á€€á€º</label>
              <textarea id="remark" placeholder="á€¡á€‘á€°á€¸á€á€á€­á€•á€¼á€¯á€›á€™á€Šá€·á€ºá€¡á€á€»á€€á€ºá€™á€»á€¬á€¸ / internal note..."></textarea>
            </div>

            <div class="actions">
              <button type="button" class="btn btn-outline" id="gotoInvoiceFromEntry">Preview Invoice</button>
              <button type="reset" class="btn btn-secondary">Clear</button>
              <button type="button" class="btn btn-secondary admin-only" id="btnCancelEdit" style="display:none;">Cancel Edit</button>
              <button type="submit" class="btn btn-primary" id="saveBtn">
                <span id="saveBtnText">Save to Firebase</span> ğŸš€
              </button>
            </div>

            <div id="message" class="message"></div>
          </form>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section id="tab-dashboard" class="tab-panel">
        <div class="panel-card">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span>ğŸ“Š Admin Dashboard</span> <span class="badge">Filter â€¢ Search â€¢ Export â€¢ Edit</span></div>
              <div class="panel-desc">
                Save á€‘á€¬á€¸á€á€²á€· Appointments á€¡á€€á€¯á€”á€ºá€œá€¯á€¶á€¸ á€’á€®á€™á€¾á€¬á€•á€¼á€™á€šá€ºá‹ Staff á€€ Profit á€€á€­á€¯ **** á€•á€²á€™á€¼á€„á€ºá€™á€šá€ºá‹ Admin á€€ Edit/Export á€œá€¯á€•á€ºá€”á€­á€¯á€„á€ºá€™á€šá€ºá‹
              </div>
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <button class="btn btn-secondary" id="reloadAppointments">Reload Data</button>
              <button class="btn btn-secondary admin-only" id="exportCsv" style="display:none;">Export CSV (Excel)</button>
            </div>
          </div>

          <div class="toolbar">
            <div class="toolbar-group">
              <span>ğŸ” Search</span>
              <input type="text" id="searchText" placeholder="Name / Phone / Invoice ID" />
            </div>
            <div class="toolbar-group">
              <span>Service</span>
              <select id="filterServiceType">
                <option value="">All</option>
              </select>
            </div>
            <div class="toolbar-group">
              <span>Status</span>
              <select id="filterStatus">
                <option value="">All</option>
                <option value="Pending">Pending</option>
                <option value="Confirm">Confirm</option>
              </select>
            </div>
            <div class="toolbar-group">
              <span>Date</span>
              <input type="date" id="filterDateFrom" />
              <span>â†’</span>
              <input type="date" id="filterDateTo" />
            </div>
            <button class="btn btn-secondary" id="applyFilter">Apply Filter</button>
          </div>

          <div style="max-height: 360px; overflow:auto; border-radius:10px; border:1px solid #e5e7eb;">
            <table>
              <thead>
                <tr>
                  <th>Invoice ID</th>
                  <th>Date</th>
                  <th>Appt (D/T)</th>
                  <th>Status</th>
                  <th>Customer</th>
                  <th>Phone</th>
                  <th>Service</th>
                  <th>Location</th>
                  <th>Payment</th>
                  <th>Total</th>
                  <th>Deposit</th>
                  <th>Balance</th>
                  <th>Profit</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="appointmentsTableBody">
                <tr>
                  <td colspan="14" style="text-align:center; padding:10px;">
                    Data á€™á€›á€¾á€­á€á€±á€¸á€•á€«â€¦ "Reload Data" á€€á€­á€¯á€”á€¾á€­á€•á€ºá€•á€«
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div id="dashboardMessage" class="message"></div>
        </div>
      </section>

      <!-- INVOICE -->
      <section id="tab-invoice" class="tab-panel">
        <div class="panel-card">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span>ğŸ§¾ Invoice Generator</span> <span class="badge">HTML â†’ JPEG (500Ã—1000)</span></div>
              <div class="panel-desc">á€á€á€ºá€™á€¾á€á€ºá€‘á€¬á€¸á€á€±á€¬ Invoice ID á€–á€¼á€„á€·á€º á€¡á€á€»á€­á€”á€ºá€™á€›á€½á€±á€¸ Invoice á€€á€­á€¯ á€•á€¼á€”á€ºá€›á€¾á€¬á€–á€½á€±á€‘á€¯á€á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€šá€ºá‹</div>
            </div>
            <span class="chip">Header: THAILAND GUIDE â€“ á€‘á€­á€¯á€„á€ºá€¸á€œá€™á€ºá€¸á€Šá€½á€¾á€”á€º</span>
          </div>

          <div class="invoice-wrap">
            <div class="invoice-controls">
              <div class="field full-width">
                <label for="invoiceDocId">Invoice ID</label>
                <input type="text" id="invoiceDocId" placeholder="TG-2025-0001" />
                <small>Entry/Dashboard á€™á€¾á€¬ á€á€¯á€¶á€¸á€á€²á€·á€á€²á€· Invoice ID á€€á€­á€¯ á€‘á€Šá€·á€ºá€•á€«</small>
              </div>
              <div class="actions" style="justify-content:flex-start; margin-top:8px;">
                <button class="btn btn-secondary" id="loadInvoice">Load Invoice</button>
                <button class="btn btn-primary" id="downloadInvoiceJpeg">Download JPEG</button>
              </div>
              <div id="invoiceMessage" class="message"></div>
            </div>

            <div class="invoice-card" id="invoiceCard">
              <div class="invoice-inner">
                <div class="invoice-header-main">
                  <div class="invoice-logo">
                    <img src="logo.png" alt="Thailand Guide Logo">
                  </div>
                  <div style="display:flex;flex-direction:column;gap:2px;">
                    <div class="invoice-brand">THAILAND GUIDE</div>
                    <div class="invoice-sub">á€‘á€­á€¯á€„á€ºá€¸á€œá€™á€ºá€¸á€Šá€½á€¾á€”á€º</div>
                  </div>
                </div>

                <div class="invoice-meta-row">
                  <div id="invRefText">Invoice No: â€”</div>
                  <div id="invIssueDate">Issued: â€”</div>
                </div>

                <div class="invoice-section-title">Customer Info</div>
                <div class="invoice-grid" id="invCustomerInfo"></div>

                <div class="invoice-section-title">Service Detail</div>
                <div class="invoice-grid" id="invServiceInfo"></div>

                <div class="invoice-total">
                  <div>
                    <div style="font-weight:900;">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ (THB)</div>
                    <div id="invDepositRow" style="font-size:13px; color:#374151; display:none; margin-top:4px;">
                      (-) á€…á€›á€¶á€•á€±á€¸á€„á€½á€±
                    </div>
                    <div style="margin-top:8px; font-weight:900;">
                      Customer á€†á€®á€™á€¾á€€á€±á€¬á€€á€ºá€›á€”á€ºá€€á€»á€”á€ºá€„á€½á€±
                    </div>
                  </div>

                  <div style="text-align:right;">
                    <div class="invoice-total-amount" id="invTotalAmount">0.00</div>
                    <div id="invDepositAmount" style="font-size:14px; color:#374151; display:none; margin-top:4px;">
                      -0.00
                    </div>
                    <div class="invoice-total-amount" id="invBalanceAmount" style="margin-top:6px;">
                      0.00
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- SETTINGS (Admin only) -->
      <section id="tab-settings" class="tab-panel admin-only" style="display:none;">
        <div class="panel-card">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span>âš™ï¸ Global Settings</span> <span class="badge">Dropdown + Pricing + Telegram</span></div>
              <div class="panel-desc">
                Dropdown Option Name á€á€½á€±áŠ Service Pricing (Cost/Profit) á€á€½á€±á€€á€­á€¯ á€’á€®á€”á€±á€›á€¬á€€á€”á€± á€•á€¼á€„á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€šá€ºá‹
              </div>
            </div>
            <button class="btn btn-secondary" id="saveSettings">Save Settings</button>
          </div>

          <div class="settings-grid">
            <div class="settings-block">
              <h4>Customer Channel List</h4>
              <small>One item per line</small>
              <textarea id="channelsSetting" rows="6"></textarea>
            </div>

            <div class="settings-block">
              <h4>Service Type List</h4>
              <small>One item per line</small>
              <textarea id="servicesSetting" rows="6"></textarea>
            </div>

            <div class="settings-block">
              <h4>Payment Type List</h4>
              <small>Deposit options á€•á€«á€•á€¼á€®á€¸á€á€¬á€¸</small>
              <textarea id="paymentsSetting" rows="6"></textarea>
            </div>

            <div class="settings-block">
              <h4>Service Location List</h4>
              <small>Invoice á€‘á€²á€á€½á€„á€ºá€–á€±á€¬á€ºá€•á€¼á€™á€Šá€º</small>
              <textarea id="locationsSetting" rows="6"></textarea>
            </div>

            <div class="settings-block">
              <h4>Service Pricing (Cost / Profit per Service)</h4>
              <small>Service á€á€…á€ºá€™á€»á€­á€¯á€¸á€…á€®á€¡á€á€½á€€á€º Cost/Profit á€‘á€Šá€·á€ºá€•á€«</small>
              <div id="servicePricingContainer"></div>
            </div>

            <div class="settings-block">
              <h4>Telegram Bot Notify</h4>
              <small>(optional)</small>
              <div class="field">
                <label for="tgToken">Bot Token</label>
                <input type="text" id="tgToken" placeholder="123456789:ABC-YourBotToken" />
              </div>
              <div class="field">
                <label for="tgChatId">Chat ID</label>
                <input type="text" id="tgChatId" placeholder="@yourchannel or numeric chat id" />
              </div>
              <small style="color:#b91c1c;">
                âš ï¸ Public hosting á€™á€¾á€¬ token á€‘á€Šá€·á€ºá€á€¬ á€™á€œá€¯á€¶á€á€¼á€¯á€¶á€•á€« (Internal only)
              </small>
            </div>
          </div>

          <div id="settingsMessage" class="message"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, serverTimestamp, getDocs, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBrXn36vL3_Ls4o4mTqaR_HGELJpQEpAw0",
      authDomain: "thaiguide-cf5e2.firebaseapp.com",
      projectId: "thaiguide-cf5e2",
      storageBucket: "thaiguide-cf5e2.firebasestorage.app",
      messagingSenderId: "854706477616",
      appId: "1:854706477616:web:64c1025ee4b657ab12abf5",
      measurementId: "G-25NVRZYGEZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;
    let currentRole = "guest";

    let dropdownSettings = {
      customerChannels: ["Facebook Page","Messenger","Telegram","Line","Phone Call","Walk-in","Agent / Referral","Other"],
      serviceTypes: ["Bank Account Opening","Visa Service","TM30 / 90 Days Report","Money Exchange","Flight / Ticket","Other Service"],
      paymentTypes: ["Cash","Bank Transfer","QR Payment","Deposit (Partial)","Deposit (50%)","Deposit (Custom)","Free of Charge"],
      locations: ["Chiang Mai Office","Bangkok Office","Online Service"]
    };

    let servicePricing = {};
    let telegramSettings = { botToken: "", chatId: "" };

    let cachedAppointments = [];
    let lastFilteredAppointments = [];
    let lastSavedDocId = null;
    let lastSavedData = null;
    let editingDocId = null;

    const $ = (id) => document.getElementById(id);

    // ---------- AUTH ----------
    $("loginBtn").addEventListener("click", async () => {
      const email = $("loginEmail").value.trim();
      const pwd = $("loginPassword").value;
      if (!email || !pwd) return alert("Email / Password á€–á€¼á€Šá€·á€ºá€•á€±á€¸á€•á€«");

      $("loginBtn").disabled = true;
      $("loginBtn").textContent = "Logging in...";
      try {
        await signInWithEmailAndPassword(auth, email, pwd);
      } catch (e) {
        alert("Login Error: " + e.message);
        $("loginBtn").disabled = false;
        $("loginBtn").textContent = "Login";
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      try { await signOut(auth); } catch(e) {}
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;

      if (user) {
        let role = "staff";
        try {
          const uDoc = await getDoc(doc(db, "users", user.email));
          if (uDoc.exists()) {
            const d = uDoc.data();
            if (d.role === "admin" || d.role === "staff") role = d.role;
          }
        } catch(e) { console.error("role lookup error", e); }
        currentRole = role;

        $("authStatus").textContent = `Logged in as ${user.email} (${currentRole})`;
        $("loginBtn").disabled = true;
        $("loginEmail").disabled = true;
        $("loginPassword").disabled = true;
        $("logoutBtn").style.display = "inline-flex";
      } else {
        currentRole = "guest";
        $("authStatus").textContent = "Not signed in";
        $("loginBtn").disabled = false;
        $("loginBtn").textContent = "Login";
        $("loginEmail").disabled = false;
        $("loginPassword").disabled = false;
        $("logoutBtn").style.display = "none";
      }

      updateRoleUI();
      updateAuthUI();

      if (user) {
        await loadSettingsFromFirestore();
        await loadAppointments();
      }
    });

    function updateAuthUI() {
      const overlay = $("authOverlay");
      const locked = currentRole === "guest";
      overlay.classList.toggle("hidden", !locked);

      const protectedButtons = [
        "saveBtn", "btnCancelEdit", "gotoInvoiceFromEntry",
        "reloadAppointments", "exportCsv", "applyFilter",
        "loadInvoice", "downloadInvoiceJpeg", "saveSettings"
      ];
      protectedButtons.forEach(id => { const el = $(id); if (el) el.disabled = locked; });

      const inputs = document.querySelectorAll(
        "#appointmentForm input, #appointmentForm select, #appointmentForm textarea," +
        "#tab-dashboard input, #tab-dashboard select," +
        "#tab-invoice input," +
        "#tab-settings input, #tab-settings textarea"
      );
      inputs.forEach(el => { locked ? el.setAttribute("disabled","disabled") : el.removeAttribute("disabled"); });

      $("loginEmail").disabled = !!currentUser;
      $("loginPassword").disabled = !!currentUser;
    }

    function updateRoleUI() {
      const settingsTabBtn = $("settingsTabBtn");
      const settingsPanel = $("tab-settings");
      if (currentRole === "admin") {
        if (settingsTabBtn) settingsTabBtn.style.display = "";
        if (settingsPanel) settingsPanel.style.display = "";
      } else {
        if (settingsTabBtn) settingsTabBtn.style.display = "none";
        if (settingsPanel) settingsPanel.style.display = "none";
      }

      document.querySelectorAll(".admin-only").forEach(el => {
        if (el.id === "tab-settings") return;
        el.style.display = (currentRole === "admin") ? "" : "none";
      });

      document.querySelectorAll(".profit-cell").forEach(td => {
        const real = td.dataset.profit || "";
        td.textContent = real ? (currentRole === "admin" ? real : "****") : "";
      });

      updateAuthUI();
    }

    // ---------- TABS ----------
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        if (tab === "settings" && currentRole !== "admin") return;

        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
        btn.classList.add("active");
        $("tab-" + tab).classList.add("active");
      });
    });

    // ---------- DROPDOWNS / SETTINGS ----------
    function fillSelect(select, arr, addEmpty = true) {
      select.innerHTML = "";
      if (addEmpty) {
        const opt = document.createElement("option");
        opt.value = ""; opt.textContent = "-- Select --";
        select.appendChild(opt);
      }
      arr.forEach(v => {
        const o = document.createElement("option");
        o.value = o.textContent = v;
        select.appendChild(o);
      });
    }

    function renderServicePricingEditor() {
      const container = $("servicePricingContainer");
      if (!container) return;
      container.innerHTML = "";
      dropdownSettings.serviceTypes.forEach(name => {
        const row = document.createElement("div");
        row.className = "pricing-row";
        const sp = servicePricing[name] || { cost: "", profit: "" };
        row.innerHTML = `
          <span title="${name}">${name}</span>
          <input type="number" min="0" step="0.01" placeholder="Cost" data-sp-cost="${name}" value="${sp.cost ?? ""}">
          <input type="number" min="0" step="0.01" placeholder="Profit" data-sp-profit="${name}" value="${sp.profit ?? ""}">
        `;
        container.appendChild(row);
      });
    }

    function renderDropdowns() {
      fillSelect($("channel"), dropdownSettings.customerChannels, true);
      fillSelect($("serviceType"), dropdownSettings.serviceTypes, true);
      fillSelect($("paymentType"), dropdownSettings.paymentTypes, true);
      fillSelect($("location"), dropdownSettings.locations, true);

      const filterService = $("filterServiceType");
      filterService.innerHTML = "";
      const all = document.createElement("option");
      all.value = ""; all.textContent = "All";
      filterService.appendChild(all);
      dropdownSettings.serviceTypes.forEach(v => {
        const o = document.createElement("option");
        o.value = o.textContent = v;
        filterService.appendChild(o);
      });

      renderServicePricingEditor();
    }

    async function loadSettingsFromFirestore() {
      try {
        const ddSnap = await getDoc(doc(db, "settings", "dropdowns"));
        if (ddSnap.exists()) {
          const d = ddSnap.data();
          dropdownSettings.customerChannels = d.customerChannels || dropdownSettings.customerChannels;
          dropdownSettings.serviceTypes = d.serviceTypes || dropdownSettings.serviceTypes;
          dropdownSettings.paymentTypes = d.paymentTypes || dropdownSettings.paymentTypes;
          dropdownSettings.locations = d.locations || dropdownSettings.locations;
        }

        const tgSnap = await getDoc(doc(db, "settings", "telegram"));
        if (tgSnap.exists()) {
          const t = tgSnap.data();
          telegramSettings.botToken = t.botToken || "";
          telegramSettings.chatId = t.chatId || "";
        }

        const spSnap = await getDoc(doc(db, "settings", "servicePricing"));
        if (spSnap.exists()) {
          const sp = spSnap.data();
          servicePricing = sp.services || {};
        }
      } catch (e) {
        console.error("Load settings error:", e);
      }

      renderDropdowns();

      if ($("channelsSetting")) $("channelsSetting").value = dropdownSettings.customerChannels.join("\n");
      if ($("servicesSetting")) $("servicesSetting").value = dropdownSettings.serviceTypes.join("\n");
      if ($("paymentsSetting")) $("paymentsSetting").value = dropdownSettings.paymentTypes.join("\n");
      if ($("locationsSetting")) $("locationsSetting").value = dropdownSettings.locations.join("\n");
      if ($("tgToken")) $("tgToken").value = telegramSettings.botToken;
      if ($("tgChatId")) $("tgChatId").value = telegramSettings.chatId;
    }

    $("saveSettings").addEventListener("click", async () => {
      const msg = $("settingsMessage");
      msg.textContent = ""; msg.className = "message";

      dropdownSettings.customerChannels = $("channelsSetting").value.split("\n").map(s=>s.trim()).filter(Boolean);
      dropdownSettings.serviceTypes = $("servicesSetting").value.split("\n").map(s=>s.trim()).filter(Boolean);
      dropdownSettings.paymentTypes = $("paymentsSetting").value.split("\n").map(s=>s.trim()).filter(Boolean);
      dropdownSettings.locations = $("locationsSetting").value.split("\n").map(s=>s.trim()).filter(Boolean);

      const newPricing = {};
      dropdownSettings.serviceTypes.forEach(n => newPricing[n] = { cost: 0, profit: 0 });

      document.querySelectorAll("[data-sp-cost]").forEach(input => {
        const name = input.dataset.spCost;
        const val = parseFloat(input.value);
        if (!isNaN(val)) { newPricing[name] = newPricing[name] || {}; newPricing[name].cost = val; }
      });
      document.querySelectorAll("[data-sp-profit]").forEach(input => {
        const name = input.dataset.spProfit;
        const val = parseFloat(input.value);
        if (!isNaN(val)) { newPricing[name] = newPricing[name] || {}; newPricing[name].profit = val; }
      });

      servicePricing = newPricing;
      telegramSettings.botToken = $("tgToken").value.trim();
      telegramSettings.chatId = $("tgChatId").value.trim();

      try {
        await setDoc(doc(db, "settings", "dropdowns"), dropdownSettings, { merge: true });
        await setDoc(doc(db, "settings", "telegram"), telegramSettings, { merge: true });
        await setDoc(doc(db, "settings", "servicePricing"), { services: servicePricing }, { merge: true });

        renderDropdowns();
        msg.textContent = "âœ… Settings saved.";
        msg.className = "message success";
      } catch(e) {
        msg.textContent = "âŒ Save settings failed: " + e.message;
        msg.className = "message error";
      }
    });

    // âœ… Time picker: click/focus => open picker where supported
    const timeInput = $("appointmentTime");
    ["click","focus"].forEach(evt=>{
      timeInput.addEventListener(evt, () => {
        if (typeof timeInput.showPicker === "function") timeInput.showPicker();
      });
    });

    // âœ… Balance Auto: always Total - Deposit, regardless of payment type
    function updateDepositUI() {
      const total = Number($("price").value || 0);
      const deposit = Number($("depositAmount").value || 0);
      const balance = Math.max(total - deposit, 0);
      $("balanceAmount").value = balance.toFixed(2);
    }
    $("paymentType").addEventListener("change", updateDepositUI);
    $("price").addEventListener("input", updateDepositUI);
    $("depositAmount").addEventListener("input", updateDepositUI);

    // ---------- ENTRY SAVE / EDIT ----------
    const form = $("appointmentForm");
    const messageDiv = $("message");

    $("btnCancelEdit").addEventListener("click", () => {
      editingDocId = null;
      $("invoiceId").disabled = false;
      $("saveBtnText").textContent = "Save to Firebase";
      $("btnCancelEdit").style.display = "none";
      messageDiv.textContent = "";
      form.reset();
      updateDepositUI();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (currentRole === "guest") return;

      messageDiv.textContent = "";
      messageDiv.className = "message";

      const invoiceIdRaw = $("invoiceId").value.trim();
      const invoiceId = invoiceIdRaw.toUpperCase();

      const total = Number($("price").value || 0);
      const dep = Number($("depositAmount").value || 0);
      const bal = Math.max(total - dep, 0);

      const data = {
        invoiceId,
        date: $("date").value,
        appointmentDate: $("appointmentDate").value,
        appointmentTime: $("appointmentTime").value || null, // âœ… optional
        name: $("name").value.trim(),
        phone: $("phone").value.trim(),
        customerStatus: $("customerStatus").value,
        channel: $("channel").value || null,
        location: $("location").value,
        serviceType: $("serviceType").value,
        paymentType: $("paymentType").value,
        price: total,
        depositAmount: dep,
        balanceAmount: bal,
        remark: $("remark").value.trim() || null,
        createdAt: serverTimestamp(),
        createdBy: currentUser ? currentUser.email : null
      };

      // âœ… Required: Time á€€á€­á€¯ á€™á€…á€…á€ºá€á€±á€¬á€· (optional)
      if (!invoiceId || !data.date || !data.appointmentDate || !data.name || !data.phone ||
          !data.serviceType || !data.paymentType || !data.location || !data.customerStatus) {
        messageDiv.textContent = "Required Field á€á€á€»á€­á€¯á€· á€™á€•á€¼á€Šá€·á€ºá€á€±á€¸á€•á€« â€“ á€–á€¼á€Šá€·á€ºá€•á€¼á€®á€¸á€”á€±á€¬á€€á€º Save á€œá€¯á€•á€ºá€•á€«á‹";
        messageDiv.className = "message error";
        return;
      }

      const sp = servicePricing[data.serviceType] || {};
      const cost = typeof sp.cost === "number" ? sp.cost : 0;
      let profit = typeof sp.profit === "number" ? sp.profit : undefined;
      if (profit === undefined || isNaN(profit)) profit = data.price - cost;
      data.serviceCost = cost;
      data.serviceProfit = profit;

      try {
        if (editingDocId && editingDocId === invoiceId) {
          await setDoc(doc(db, "appointments", editingDocId), data, { merge: true });
          lastSavedDocId = editingDocId;
          lastSavedData = { ...data, id: editingDocId };

          messageDiv.textContent = "âœ… Updated! Invoice ID: " + editingDocId;
          messageDiv.className = "message success";

          editingDocId = null;
          $("invoiceId").disabled = false;
          $("saveBtnText").textContent = "Save to Firebase";
          $("btnCancelEdit").style.display = "none";
          form.reset(); updateDepositUI();
          await loadAppointments();
        } else {
          const existing = await getDoc(doc(db, "appointments", invoiceId));
          if (existing.exists()) {
            messageDiv.textContent = "âŒ á€’á€® Invoice ID á€”á€²á€· Data á€›á€¾á€­á€•á€¼á€®á€¸á€á€¬á€¸ â€“ á€¡á€á€…á€º ID á€á€…á€ºá€á€¯ á€•á€±á€¸á€•á€«á‹";
            messageDiv.className = "message error";
            return;
          }
          await setDoc(doc(db, "appointments", invoiceId), data);
          lastSavedDocId = invoiceId;
          lastSavedData = { ...data, id: invoiceId };

          messageDiv.textContent = "âœ… Saved! Invoice ID: " + invoiceId;
          messageDiv.className = "message success";

          await sendTelegramNotification(lastSavedData);
          form.reset(); updateDepositUI();
          await loadAppointments();
        }
      } catch (err) {
        console.error(err);
        messageDiv.textContent = "âŒ Error saving data: " + err.message;
        messageDiv.className = "message error";
      }
    });

    // ---------- TELEGRAM ----------
    async function sendTelegramNotification(a) {
      if (!telegramSettings.botToken || !telegramSettings.chatId) return;
      const apptDT = `${a.appointmentDate || "-"}${a.appointmentTime ? (" " + a.appointmentTime) : ""}`;

      const lines = [
        "ğŸ“© *New Appointment Saved*",
        "",
        `ğŸ§¾ Invoice ID: ${a.invoiceId}`,
        `ğŸŸ¡ Status: ${a.customerStatus || "-"}`,
        `ğŸ‘¤ Name: ${a.name}`,
        `ğŸ“ Phone: ${a.phone}`,
        `ğŸ“ Location: ${a.location}`,
        `ğŸ“… Service Date: ${a.date}`,
        `ğŸ•’ Appointment: ${apptDT}`,
        `ğŸ§¾ Service: ${a.serviceType}`,
        `ğŸ’³ Payment: ${a.paymentType}`,
        `ğŸ’° Total: ${Number(a.price||0).toFixed(2)} THB`,
        `ğŸ’µ Deposit: ${Number(a.depositAmount||0).toFixed(2)} | Balance: ${Number(a.balanceAmount||0).toFixed(2)}`,
        a.channel ? `ğŸ“¡ Channel: ${a.channel}` : "",
        a.remark ? `ğŸ“ Remark: ${a.remark}` : ""
      ].filter(Boolean);

      try {
        await fetch(`https://api.telegram.org/bot${telegramSettings.botToken}/sendMessage`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            chat_id: telegramSettings.chatId,
            text: lines.join("\n"),
            parse_mode: "Markdown"
          })
        });
      } catch(e) {
        console.error("Telegram error", e);
      }
    }

    // ---------- DASHBOARD LOAD ----------
    async function loadAppointments() {
      if (currentRole === "guest") return;

      const body = $("appointmentsTableBody");
      body.innerHTML = `<tr><td colspan="14" style="text-align:center;padding:8px;">Loading...</td></tr>`;
      $("dashboardMessage").textContent = "";

      try {
        const snap = await getDocs(collection(db, "appointments"));
        const list = [];
        snap.forEach(ds => list.push({ id: ds.id, ...ds.data() }));

        list.sort((a,b) => {
          const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
          const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
          return tb - ta;
        });

        cachedAppointments = list;
        renderAppointmentsTable();
      } catch(e) {
        console.error(e);
        body.innerHTML = `<tr><td colspan="14" style="text-align:center;padding:8px;color:#b91c1c;">Error loading: ${e.message}</td></tr>`;
      }
    }

    function statusPill(status){
      const s = (status || "").toLowerCase();
      if (s === "confirm") return `<span class="status-pill status-confirm">Confirm</span>`;
      if (s === "pending") return `<span class="status-pill status-pending">Pending</span>`;
      return `<span class="status-pill">-</span>`;
    }

    function renderAppointmentsTable() {
      const body = $("appointmentsTableBody");
      body.innerHTML = "";

      const searchText = $("searchText").value.trim().toLowerCase();
      const filterService = $("filterServiceType").value;
      const filterStatus = $("filterStatus").value;
      const dateFrom = $("filterDateFrom").value;
      const dateTo = $("filterDateTo").value;

      const filtered = cachedAppointments.filter(a => {
        let ok = true;
        if (searchText) {
          const s = `${a.name||""} ${a.phone||""} ${a.invoiceId||a.id||""}`;
          ok = s.toLowerCase().includes(searchText);
        }
        if (ok && filterService) ok = a.serviceType === filterService;
        if (ok && filterStatus) ok = (a.customerStatus||"") === filterStatus;
        if (ok && (dateFrom || dateTo)) {
          const d = a.date || "";
          if (dateFrom && d < dateFrom) ok = false;
          if (dateTo && d > dateTo) ok = false;
        }
        return ok;
      });

      lastFilteredAppointments = filtered;

      if (!filtered.length) {
        body.innerHTML = `<tr><td colspan="14" style="text-align:center;padding:8px;">Result á€™á€›á€¾á€­á€•á€«</td></tr>`;
        return;
      }

      filtered.forEach(a => {
        const profit = (a.serviceProfit != null)
          ? a.serviceProfit
          : (a.price != null && a.serviceCost != null)
            ? (a.price - a.serviceCost)
            : null;
        const profitText = profit != null ? Number(profit).toFixed(2) : "";
        const displayProfit = (currentRole === "admin") ? profitText : (profitText ? "****" : "");

        const dep = Number(a.depositAmount||0).toFixed(2);
        const bal = Number(a.balanceAmount||0).toFixed(2);

        const apptDT = `${a.appointmentDate || ""}${a.appointmentTime ? (" " + a.appointmentTime) : ""}`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${(a.invoiceId || a.id || "").toUpperCase()}</td>
          <td>${a.date || ""}</td>
          <td>${apptDT || ""}</td>
          <td>${statusPill(a.customerStatus)}</td>
          <td>${a.name || ""}</td>
          <td>${a.phone || ""}</td>
          <td><span class="tag">${a.serviceType || ""}</span></td>
          <td>${a.location || ""}</td>
          <td>${a.paymentType || ""}</td>
          <td>${a.price != null ? Number(a.price).toFixed(2) : ""}</td>
          <td>${dep}</td>
          <td>${bal}</td>
          <td class="profit-cell" data-profit="${profitText}">${displayProfit}</td>
          <td>
            <button class="btn btn-outline" style="padding:5px 10px;font-size:12px" data-docid="${(a.invoiceId || a.id || "").toUpperCase()}">Invoice</button>
            <button class="btn btn-secondary admin-only" style="padding:5px 10px;font-size:12px;${currentRole==="admin"?"":"display:none;"}" data-editid="${(a.invoiceId || a.id || "").toUpperCase()}">Edit</button>
          </td>
        `;
        body.appendChild(tr);

        tr.querySelector("[data-docid]").addEventListener("click", () => {
          $("invoiceDocId").value = tr.querySelector("[data-docid]").dataset.docid;
          document.querySelector('.tab-btn[data-tab="invoice"]').click();
          loadInvoice();
        });

        const editBtn = tr.querySelector("[data-editid]");
        if (editBtn) editBtn.addEventListener("click", () => {
          if (currentRole !== "admin") return;
          startEditAppointment(a);
        });
      });

      updateRoleUI();
    }

    function ensureOption(select, value) {
      if (!value) return;
      const exists = Array.from(select.options).some(o => o.value === value);
      if (!exists) {
        const opt = document.createElement("option");
        opt.value = opt.textContent = value;
        select.appendChild(opt);
      }
      select.value = value;
    }

    function startEditAppointment(a) {
      editingDocId = (a.invoiceId || a.id || "").toUpperCase();
      $("invoiceId").value = editingDocId;
      $("invoiceId").disabled = true;

      $("date").value = a.date || "";
      $("appointmentDate").value = a.appointmentDate || "";
      $("appointmentTime").value = a.appointmentTime || ""; // âœ… optional
      $("name").value = a.name || "";
      $("phone").value = a.phone || "";
      $("customerStatus").value = a.customerStatus || "";

      ensureOption($("channel"), a.channel);
      ensureOption($("location"), a.location);
      ensureOption($("serviceType"), a.serviceType);
      ensureOption($("paymentType"), a.paymentType);

      $("channel").value = a.channel || "";
      $("location").value = a.location || "";
      $("serviceType").value = a.serviceType || "";
      $("paymentType").value = a.paymentType || "";
      $("price").value = a.price != null ? a.price : "";
      $("depositAmount").value = a.depositAmount != null ? a.depositAmount : "";
      $("remark").value = a.remark || "";

      updateDepositUI();

      $("saveBtnText").textContent = "Update Appointment";
      $("btnCancelEdit").style.display = (currentRole === "admin") ? "inline-flex" : "none";

      const msg = $("message");
      msg.textContent = "Edit Mode: Invoice " + editingDocId;
      msg.className = "message";

      document.querySelector('.tab-btn[data-tab="entry"]').click();
    }

    $("reloadAppointments").addEventListener("click", loadAppointments);
    $("applyFilter").addEventListener("click", renderAppointmentsTable);

    $("exportCsv").addEventListener("click", () => {
      if (currentRole !== "admin") return;
      if (!lastFilteredAppointments.length) return alert("Export á€œá€¯á€•á€ºá€™á€šá€·á€º data á€™á€›á€¾á€­á€•á€«á‹");

      const rows = [];
      rows.push([
        "Invoice ID","Date","Appointment Date","Appointment Time","Status","Name","Phone",
        "Channel","Location","Service Type","Payment Type","Total","Deposit","Balance",
        "Service Cost","Service Profit","Remark"
      ]);

      lastFilteredAppointments.forEach(a => {
        rows.push([
          (a.invoiceId || a.id || "").toUpperCase(),
          a.date || "",
          a.appointmentDate || "",
          a.appointmentTime || "",
          a.customerStatus || "",
          a.name || "",
          a.phone || "",
          a.channel || "",
          a.location || "",
          a.serviceType || "",
          a.paymentType || "",
          a.price != null ? a.price : "",
          a.depositAmount != null ? a.depositAmount : "",
          a.balanceAmount != null ? a.balanceAmount : "",
          a.serviceCost != null ? a.serviceCost : "",
          a.serviceProfit != null ? a.serviceProfit : "",
          a.remark || ""
        ]);
      });

      const csv = rows.map(r => r.map(v => `"${String(v ?? "").replace(/"/g,'""')}"`).join(",")).join("\r\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "appointments_export.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    // ---------- INVOICE ----------
    async function loadInvoice() {
      if (currentRole === "guest") return;

      const id = ($("invoiceDocId").value.trim() || lastSavedDocId || "").toUpperCase();
      const msg = $("invoiceMessage");
      msg.textContent = ""; msg.className = "message";

      if (!id) {
        msg.textContent = "Invoice ID á€‘á€Šá€·á€ºá€•á€« (á€á€­á€¯á€·) Dashboard á€™á€¾ Invoice á€€á€­á€¯á€”á€¾á€­á€•á€ºá€•á€«";
        msg.className = "message error";
        return;
      }

      try {
        const snap = await getDoc(doc(db, "appointments", id));
        if (!snap.exists()) {
          msg.textContent = "á€¡á€²á€·á€’á€® Invoice ID á€”á€²á€· Appointment á€™á€á€½á€±á€·á€•á€«";
          msg.className = "message error";
          return;
        }
        const data = snap.data();
        fillInvoiceCard(id, data);
        msg.textContent = "âœ… Invoice loaded.";
        msg.className = "message success";
      } catch(e) {
        msg.textContent = "âŒ Error loading invoice: " + e.message;
        msg.className = "message error";
      }
    }

    // âœ… Invoice: Time included (optional); Date included; Status + Service Date not shown
    // âœ… Total/Deposit/Balance Due
    function fillInvoiceCard(id, data) {
      const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();
      $("invRefText").textContent = `Invoice No: ${id}`;
      $("invIssueDate").textContent = `Issued: ${createdAt.toLocaleDateString()} ${createdAt.toLocaleTimeString()}`;

      const timeText = data.appointmentTime ? ` ${data.appointmentTime}` : "";

      $("invCustomerInfo").innerHTML = `
        <div><span class="invoice-label">á€¡á€™á€Šá€º</span><br/><span class="invoice-value">${data.name || "-"}</span></div>
        <div><span class="invoice-label">á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º</span><br/><span class="invoice-value">${data.phone || "-"}</span></div>
        <div><span class="invoice-label">á€á€”á€ºá€†á€±á€¬á€„á€ºá€™á€¾á€¯á€šá€°á€™á€Šá€·á€ºá€”á€±á€›á€¬</span><br/><span class="invoice-value">${data.location || "-"}</span></div>
        <div><span class="invoice-label">á€á€”á€ºá€†á€±á€¬á€„á€ºá€™á€¾á€¯á€›á€šá€°á€™á€Šá€·á€ºá€›á€€á€º / á€¡á€á€»á€­á€”á€º</span><br/>
          <span class="invoice-value">${data.appointmentDate || "-"}${timeText}</span>
        </div>
      `;

      $("invServiceInfo").innerHTML = `
        <div><span class="invoice-label">á€á€”á€ºá€†á€±á€¬á€„á€ºá€™á€¾á€¯á€¡á€™á€»á€­á€¯á€¸á€¡á€…á€¬á€¸</span><br/><span class="invoice-value">${data.serviceType || "-"}</span></div>
        <div><span class="invoice-label">á€„á€½á€±á€•á€±á€¸á€á€»á€±á€™á€¾á€¯á€¡á€™á€»á€­á€¯á€¸á€¡á€…á€¬á€¸</span><br/><span class="invoice-value">${data.paymentType || "-"}</span></div>
        <div><span class="invoice-label">á€™á€¾á€á€ºá€á€»á€€á€º</span><br/><span class="invoice-value">${data.remark || "-"}</span></div>
        <div><span class="invoice-label"></span><br/><span class="invoice-value"></span></div>
      `;

      const total = Number(data.price || 0);
      const deposit = Number(data.depositAmount || 0);
      const balance = Math.max(total - deposit, 0);

      $("invTotalAmount").textContent = total.toFixed(2);
      $("invBalanceAmount").textContent = balance.toFixed(2);

      if (deposit > 0) {
        $("invDepositRow").style.display = "block";
        $("invDepositAmount").style.display = "block";
        $("invDepositAmount").textContent = "-" + deposit.toFixed(2);
      } else {
        $("invDepositRow").style.display = "none";
        $("invDepositAmount").style.display = "none";
      }
    }

    $("loadInvoice").addEventListener("click", loadInvoice);

    $("gotoInvoiceFromEntry").addEventListener("click", () => {
      if (lastSavedDocId) $("invoiceDocId").value = lastSavedDocId;
      document.querySelector('.tab-btn[data-tab="invoice"]').click();
      if (lastSavedDocId) loadInvoice();
    });

    $("downloadInvoiceJpeg").addEventListener("click", async () => {
      if (currentRole === "guest") return;

      const card = $("invoiceCard");
      const msg = $("invoiceMessage");
      msg.textContent = "Rendering JPEG...";
      msg.className = "message";

      try {
        const canvas = await html2canvas(card, { scale: 3, useCORS: true });
        const link = document.createElement("a");
        link.download = "invoice-" + (($("invoiceDocId").value.trim() || "preview").toUpperCase()) + ".jpg";
        link.href = canvas.toDataURL("image/jpeg", 0.92);
        link.click();
        msg.textContent = "âœ… JPEG Downloaded.";
        msg.className = "message success";
      } catch(e) {
        msg.textContent = "âŒ Error generating JPEG: " + e.message;
        msg.className = "message error";
      }
    });

    // Initial
    updateAuthUI();
    renderDropdowns();
    updateDepositUI();
  </script>
</body>
</html>
